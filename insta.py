from instaclient import InstaClient
from instaclient.errors import *
from credentials import *
import os
from datetime import datetime
from discord_webhook import DiscordWebhook, DiscordEmbed
import time
import gspread


# Initialise Time
now = datetime.now()
init_time = now.strftime("%H:%M:%S")
init_time_with_day = now.strftime("%Y-%m-%d %H:%M:%S.%f")

# # Uncomment if you want to prompt user for account to scrape. Else will use credentials.py's version
# scrape_username = input("Enter an Instagram account's username to scrape it's data: ")

# CREDIT
# https://medium.com/scrape-instagram-followers/scrape-instagram-followers-with-python-eba64e84048


# ! SCRAPING

# Create a instaclient object. Place as driver_path argument the path that leads to where you saved the chromedriver.exe file
client = InstaClient(driver_path=driver_path, localhost_headless=True)

# # Backup where headless is not desired.
# client = InstaClient(driver_path=driver_path)

try:
    # Login
    client.login(username=username, password=password)
except VerificationCodeNecessary:
    # This error is raised if the user has 2FA turned on.
    code = input('Enter the 2FA security code generated by your Authenticator App or sent to you by SMS')
    client.input_verification_code(code)
except SuspisciousLoginAttemptError as error:
    # This error is raised by Instagram's anti-bot measures
    if error.mode == SuspisciousLoginAttemptError.EMAIL:
        code = input('Enter the security code that was sent to you via email: ')
    else:
        code = input('Enter the security code that was sent to you via SMS: ')
    client.input_security_code(code)

time.sleep(5) # Sleep 5 seconds to not be a bot

# Scrape Instagram followers
try:
    # Try to get the users following the scrape user, as aTuple
    followers = client.get_followers(user=scrape_username, count=None, use_api=False, callback_frequency=100)
    # Changing from Tuple to List (Taking only the first item in Tuple)
    followers = followers[0]
except InvalidUserError:
    # Exception raised if the username is not valid
    print('The username is not valid')
except PrivateAccountError:
    # Exception raised if the account you are trying to scrape is private
    print('{} is a private account'.format(scrape_username))
except:
    client.disconnect()

time.sleep(15) # Sleep 15 seconds to chill out

# Scrape Instagram following
try:
    # Try to get the users following the scrape user, as a Tuple
    following = client.get_following(user=scrape_username, count=None, use_api=False, callback_frequency=100)
    # Changing from Tuple to List (Taking only the first item in Tuple)
    following = following[0]
except InvalidUserError:
    # Exception raised if the username is not valid
    print('The username is not valid')
except PrivateAccountError:
    # Exception raised if the account you are trying to scrape is private
    print('{} is a private account'.format(scrape_username))
except:
    client.disconnect()

time.sleep(30) # Sleep 30 seconds to chill out

# Scrape Instagram profile information
try:
    # Scrape profile into 'profile' object
    profile = client.get_profile(scrape_username)
except:
    client.disconnect()
    print("COULD NOT GET PROFILE INFORMATION")

time.sleep(5) # Sleep 5 seconds to chill out

# Closing the client to prevent memory leaks
client.disconnect()

time.sleep(5) # Sleep 5 seconds to chill out


# DATA PROCESSING & READING/SAVING TO FILE


# Processing Data (finding differences)
following_me_only = list((set(followers) - set(following)))
following_them_only = list((set(following) - set(followers)))


# defining empty lists
old_following_me_only =  []
old_following_them_only = []


# Reading files
if os.path.exists('following_me_only.txt'):
    with open('following_me_only.txt', 'r') as filehandle:
        old_following_me_only = [current_place.rstrip() for current_place in filehandle.readlines()]
else:
    print("following_me_only file does not exist, skipping reading...")
    
if os.path.exists('following_them_only.txt'):
    with open('following_them_only.txt', 'r') as filehandle:
        old_following_them_only = [current_place.rstrip() for current_place in filehandle.readlines()]
else:
    print("following_them_only file does not exist, skipping reading...")


# Comparing old and current lists
if os.path.exists('following_me_only.txt') and os.path.exists('following_them_only.txt'):
    new_following_me_only = list(set(following_me_only) - set(old_following_me_only))
    nolonger_following_me_only = list(set(old_following_me_only) - set(following_me_only))
    new_following_them_only = list(set(following_them_only) - set(old_following_them_only))
    nolonger_following_them_only = list(set(old_following_them_only) - set(following_them_only))

else:
    print("Skipping comparing old and current lists. Loading the lists as full")
    new_following_me_only = following_me_only
    new_following_them_only = following_them_only
    # Set nolonger vars as empty lists to prevent errors.
    nolonger_following_me_only = []
    nolonger_following_them_only = []


# Overwriting files with new data.
with open('following_me_only.txt', 'w') as filehandle:
    filehandle.writelines("%s\n" % user for user in following_me_only)

with open('following_them_only.txt', 'w') as filehandle:
    filehandle.writelines("%s\n" % user for user in following_them_only)


# Putting Lengths into variable since I'm lazy.
length_new_following_me_only = len(new_following_me_only)
length_nolonger_following_me_only = len(nolonger_following_me_only)
length_new_following_them_only = len(new_following_them_only)
length_nolonger_following_them_only = len(nolonger_following_them_only)


# Converting into comma separated string for readability
"""NOTE THIS ALSO CHANGES VARS FROM LIST to STR"""
new_following_me_only = (', '.join(new_following_me_only))
nolonger_following_me_only = (', '.join(nolonger_following_me_only))
new_following_them_only = (', '.join(new_following_them_only))
nolonger_following_them_only = (', '.join(nolonger_following_them_only))


# Creating identicals for gspread use. String format with commas, but underscores NOT escaped.
sheet_new_following_me_only = new_following_me_only
sheet_nolonger_following_me_only = nolonger_following_me_only
sheet_new_following_them_only = new_following_them_only
sheet_nolonger_following_them_only = nolonger_following_them_only


# Escaping any underscores - to prevent discord formatting
new_following_me_only = new_following_me_only.replace("_", "\\_")
nolonger_following_me_only = nolonger_following_me_only.replace("_", "\\_")
new_following_them_only = new_following_them_only.replace("_", "\\_")
nolonger_following_me_only = nolonger_following_me_only.replace("_", "\\_")


# Splitting string into 1000 characters per list, since webhooks' embed description are limited to 1024 characters
# Maxmimum message length? Will split message(s) into this number if required.
# Split Function
def string_divide(string, div):
       list = []
       for i in range(0, len(string), div):
           list.append(string[i:i+div])
       return list


# How many chars in each string in the list?
split_length = 1000

# Splitting
new_following_me_only = string_divide(new_following_me_only, split_length)
nolonger_following_me_only = string_divide(nolonger_following_me_only, split_length)
new_following_them_only = string_divide(new_following_them_only, split_length)
nolonger_following_them_only = string_divide(nolonger_following_them_only, split_length)


# WEBHOOK SENDING

# Webhook Config
webhook = DiscordWebhook(url=discord_webhook_url, avatar_url="https://i.imgur.com/IpIG5TP.png", username="Instagram Statistics Tracker")
footer_text = "Silverarmor's Instagram tracking of " + scrape_username

# # Webhook Data Message
# VARS
data_description = "**Ran Successfully**\nTracking " + scrape_username
data_details = "**Name** - " + str(profile.name) + "\n**Private** - " + str(profile.is_private) + "\n**Business Account** - " + str(profile.is_business_account) +  "\n**Posts Count** - " + str(profile.post_count)
data_summary  = "**Users who stopped following you** - " + str(length_nolonger_following_me_only) + "\n**Users who started following you** - " + str(length_new_following_me_only) + "\n**Users you stopped following** - " + str(length_nolonger_following_them_only) + "\n**Users you started following** - " + str(length_new_following_them_only)
data_bio = "```" + profile.biography + "```"  # placing bio in triple backticks for code block

# Colours
color_data = 0x7289da
color_nolonger_following_me = 0xFF0000
color_new_following_me = 0x00FF00
color_nolonger_following_them = 0xFFFF00
color_new_following_them = 0xFFA500
color_no_change = 0xbfff00


# General Data Webhook
embed = DiscordEmbed(title="Silverarmor's Instagram Tracker", description=data_description, color=color_data)
embed.set_timestamp()
embed.set_footer(text="Initialised at " + str(init_time))

embed.set_thumbnail(url='https://i.imgur.com/IpIG5TP.png')

embed.add_embed_field(name="Basic Data", value="**Followers Count** - " + str(profile.follower_count) + "\n**Following Count** - " + str(profile.followed_count), inline=False)
embed.add_embed_field(name="Bio", value=data_bio, inline=False)
embed.add_embed_field(name="Summary", value=data_summary, inline=False)
embed.add_embed_field(name="Details", value=data_details, inline=False)


# Send General Data Webhook
webhook.add_embed(embed)
response = webhook.execute()
webhook.remove_embed(0)
time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting


# nolonger_following_me_only
if len(nolonger_following_me_only) > 0:
    for msg in nolonger_following_me_only:
        # Create embed object for webhook
        embed = DiscordEmbed(title="Users who stopped following you :angry:", description=msg, color=color_nolonger_following_me)
        # Add embed object to webhook
        webhook.add_embed(embed)
        # Send Webhook
        response = webhook.execute()
        webhook.remove_embed(0)
        time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting

elif len(nolonger_following_me_only) == 0:
    # Create embed object for webhook
    embed = DiscordEmbed(title="Users who stopped following you :angry:", description="None today!", color=color_no_change)
    # Add embed object to webhook
    webhook.add_embed(embed)
    # Send Webhook
    response = webhook.execute()
    webhook.remove_embed(0)
    time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting


# new_following_me_only
if len(new_following_me_only) > 0:
    for msg in new_following_me_only:
        # Create embed object for webhook
        embed = DiscordEmbed(title="Users who started following you", description=msg, color=color_new_following_me)
        # Add embed object to webhook
        webhook.add_embed(embed)
        # Send Webhook
        response = webhook.execute()
        webhook.remove_embed(0)
        time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting

elif len(new_following_me_only) == 0:
    # Create embed object for webhook
    embed = DiscordEmbed(title="Users who started following you", description="None today!", color=color_no_change)
    # Add embed object to webhook
    webhook.add_embed(embed)
    # Send Webhook
    response = webhook.execute()
    webhook.remove_embed(0)
    time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting


# nolonger_following_them_only
if len(nolonger_following_them_only) > 0:
    for msg in nolonger_following_them_only:
        # Create embed object for webhook
        embed = DiscordEmbed(title="Users you stopped following", description=msg, color=color_nolonger_following_them)
        # Add embed object to webhook
        webhook.add_embed(embed)
        # Send Webhook
        response = webhook.execute()
        webhook.remove_embed(0)
        time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting

elif len(nolonger_following_them_only) == 0:
    # Create embed object for webhook
    embed = DiscordEmbed(title="Users you stopped following", description="None today!", color=color_no_change)
    # Add embed object to webhook
    webhook.add_embed(embed)
    # Send Webhook
    response = webhook.execute()
    webhook.remove_embed(0)
    time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting


# new_following_them_only
if len(new_following_them_only) > 0:
    for msg in new_following_them_only:
        # Create embed object for webhook
        embed = DiscordEmbed(title="Users you started following", description=msg, color=color_new_following_them)
        # Add embed object to webhook
        webhook.add_embed(embed)
        # Send Webhook
        response = webhook.execute()
        webhook.remove_embed(0)
        time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting

elif len(new_following_them_only) == 0:
    # Create embed object for webhook
    embed = DiscordEmbed(title="Users you started following", description="None today!", color=color_no_change)
    # Add embed object to webhook
    webhook.add_embed(embed)
    # Send Webhook
    response = webhook.execute()
    webhook.remove_embed(0)
    time.sleep(0.5) # Sleep .5 secs to prevent ratelimiting

print("Webhooks Completed")

# LOGGING TO GOOGLE SHEETS

# Authenticating
gc = gspread.service_account(filename=service_account_path)
# Opening Spreadsheet
spreadsheet = gc.open_by_key(sheet_key)
# Selecting Worksheet
worksheet = spreadsheet.worksheet(scrape_username)

# Creating data
"""
Creating row_data variable (list) for appending to Worksheet
init_time_with_day: Timestamp with date.
profile.follower_count: Number of followers
profile.followed_count: Number of followings
profile.post_count: Number of posts
profile.biography: bio
profile.is_private: private?
profile.username: username
profile.name: display name

x2 of each, length and then string:
 - nolonger_following_me_only
 - new_following_me_only
 - nolonger_following_them_only
 - new_following_them_only
"""

row_data = []
row_data.append(str(init_time_with_day))
row_data.append(str(profile.follower_count)) #int
row_data.append(str(profile.followed_count)) #int
row_data.append(str(profile.post_count)) #into
row_data.append(str(profile.biography))
row_data.append(str(profile.username))
row_data.append(str(profile.name))
row_data.append(str(profile.is_private)) #bool
row_data.append(str(profile.is_verified)) #bool
row_data.append(str(profile.is_business_account))
row_data.append(str(length_nolonger_following_me_only)) #int
row_data.append(str(sheet_nolonger_following_me_only)) #list
row_data.append(str(length_new_following_me_only))
row_data.append(str(sheet_new_following_me_only)) #list
row_data.append(str(length_nolonger_following_them_only))
row_data.append(str(sheet_nolonger_following_them_only)) #list
row_data.append(str(length_new_following_them_only))
row_data.append(str(sheet_new_following_them_only)) #list
row_data.append(str(following))
row_data.append(str(followers))

# Appending to Worksheet
worksheet.append_row(row_data, value_input_option="USER_ENTERED", insert_data_option="INSERT_ROWS")

print("Sheet Updated")
